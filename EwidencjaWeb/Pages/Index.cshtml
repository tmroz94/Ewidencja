@page
@model IndexModel
@{
    ViewData["Title"] = "Ewidencja Pojazdów";
}

@section Hero {
    <div id="adCarousel" class="carousel slide mb-4" data-bs-ride="carousel" data-bs-interval="3000">
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#adCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#adCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <button type="button" data-bs-target="#adCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
            <button type="button" data-bs-target="#adCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
            <button type="button" data-bs-target="#adCarousel" data-bs-slide-to="4" aria-label="Slide 5"></button>
        </div>
        <div class="carousel-inner">
            <div class="carousel-item active">
                <a asp-page="/Services/Inspection">
                    <img src="~/img/reklama-1.png" class="d-block w-100" alt="Reklama 1">
                </a>
            </div>
            <div class="carousel-item">
                <a asp-page="/Services/WasherFluid">
                    <img src="~/img/reklama-2.png" class="d-block w-100" alt="Reklama 2">
                </a>
            </div>
            <div class="carousel-item">
                <a asp-page="/Services/EngineOil">
                    <img src="~/img/reklama-3.png" class="d-block w-100" alt="Reklama 3">
                </a>
            </div>
            <div class="carousel-item">
                <a asp-page="/Services/CleaningAccessories">
                    <img src="~/img/reklama-4.png" class="d-block w-100" alt="Reklama 4">
                </a>
            </div>
            <div class="carousel-item">
                <a asp-page="/Services/TireService">
                    <img src="~/img/reklama-5.png" class="d-block w-100" alt="Reklama 5">
                </a>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#adCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Poprzednia</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#adCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Następna</span>
        </button>
    </div>
}

<div class="container mt-4">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <div asp-validation-summary="All" class="mb-0 mt-2"></div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row align-items-center mb-3">
        <div class="col-md-6">
            <h1>Lista Pojazdów</h1>
        </div>
        <div class="col-md-6 text-md-end">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVehicleModal">
                <i class="bi bi-plus-lg"></i> Dodaj pojazd
            </button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <form asp-page="./Index" method="get">
                <div class="input-group">
                    <input type="text" name="SearchString" value="@Model.CurrentFilter" class="form-control" placeholder="Szukaj..." />
                    <button type="submit" class="btn btn-outline-secondary">Szukaj</button>
                    <a asp-page="./Index" class="btn btn-outline-secondary">Wyczyść</a>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered table-fixed-layout">
            <thead class="table-dark">
                <tr>
                    <th class="col-width-15">
                        <a asp-page="./Index" asp-route-sortOrder="@Model.NameSort" asp-route-currentFilter="@Model.CurrentFilter" class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                            <span>Nr rejestracyjny</span>
                            @Html.Raw(GetSortIcon("Name"))
                        </a>
                    </th>
                    <th class="col-width-15">
                        <a asp-page="./Index" asp-route-sortOrder="@Model.BrandSort" asp-route-currentFilter="@Model.CurrentFilter" class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                            <span>Marka</span>
                            @Html.Raw(GetSortIcon("Brand"))
                        </a>
                    </th>
                    <th class="col-width-15">
                        <a asp-page="./Index" asp-route-sortOrder="@Model.ModelSort" asp-route-currentFilter="@Model.CurrentFilter" class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                            <span>Model</span>
                            @Html.Raw(GetSortIcon("Model"))
                        </a>
                    </th>
                    <th class="col-width-15">
                        <a asp-page="./Index" asp-route-sortOrder="@Model.YearSort" asp-route-currentFilter="@Model.CurrentFilter" class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                            <span>Rok produkcji</span>
                            @Html.Raw(GetSortIcon("Year"))
                        </a>
                    </th>
                    <th class="col-width-15">
                        <a asp-page="./Index" asp-route-sortOrder="@Model.DateSort" asp-route-currentFilter="@Model.CurrentFilter" class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                            <span>Data przeglądu</span>
                            @Html.Raw(GetSortIcon("Date"))
                        </a>
                    </th>
                    <th class="w-25">
                        <a asp-page="./Index" asp-route-sortOrder="@Model.OwnerSort" asp-route-currentFilter="@Model.CurrentFilter" class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                            <span>Właściciel</span>
                            @Html.Raw(GetSortIcon("Owner"))
                        </a>
                    </th>
                    <th class="text-center col-width-actions">Akcje</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Vehicles.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            @if (!string.IsNullOrEmpty(Model.CurrentFilter))
                            {
                                <i class="bi bi-search fs-1 d-block mb-2"></i>
                                <span>Brak wyników dla wyszukiwania: "<strong>@Model.CurrentFilter</strong>"</span>
                            }
                            else
                            {
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                <span>Brak pojazdów w bazie. Dodaj pierwszy pojazd!</span>
                            }
                        </td>
                    </tr>
                }

                @foreach (var vehicle in Model.Vehicles)
                {
                    var isEditError = ViewData["OpenEditModalId"]?.ToString() == vehicle.Id.ToString();
                    var editVehicle = isEditError ? Model.NewVehicle : vehicle;

                    <tr>
                        <td data-label="Nr rejestracyjny">@vehicle.RegistrationNumber</td>
                        <td data-label="Marka">@vehicle.Brand</td>
                        <td data-label="Model">@vehicle.Model</td>
                        <td data-label="Rok produkcji">@vehicle.YearOfProduction</td>
                        <td data-label="Data przeglądu">@vehicle.InspectionDate.ToShortDateString()</td>
                        <td data-label="Właściciel">@vehicle.Owner</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning me-1" 
                                    data-bs-toggle="modal" data-bs-target="#editModal-@vehicle.Id">
                                Edytuj
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" 
                                    data-bs-toggle="modal" data-bs-target="#deleteModal-@vehicle.Id">
                                Usuń
                            </button>
                        </td>
                    </tr>

                    <div class="modal fade" id="editModal-@vehicle.Id" tabindex="-1" aria-hidden="true" @(isEditError ? "data-auto-open=true" : "")>
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="post" asp-page-handler="Edit">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edytuj pojazd</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body text-start">
                                        <input type="hidden" name="NewVehicle.Id" value="@vehicle.Id" />
                                        <input type="hidden" name="sortOrder" value="@Model.CurrentSort" />
                                        <input type="hidden" name="pageIndex" value="@Model.PageIndex" />
                                        <input type="hidden" name="currentFilter" value="@Model.CurrentFilter" />
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Nr rejestracyjny</label>
                                            <input name="NewVehicle.RegistrationNumber" value="@editVehicle.RegistrationNumber" class="form-control" />
                                            <span asp-validation-for="NewVehicle.RegistrationNumber" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Marka</label>
                                            <input name="NewVehicle.Brand" value="@editVehicle.Brand" class="form-control" />
                                            <span asp-validation-for="NewVehicle.Brand" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Model</label>
                                            <input name="NewVehicle.Model" value="@editVehicle.Model" class="form-control" />
                                            <span asp-validation-for="NewVehicle.Model" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Rok produkcji</label>
                                            <input name="NewVehicle.YearOfProduction" value="@editVehicle.YearOfProduction" class="form-control" />
                                            <span asp-validation-for="NewVehicle.YearOfProduction" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Data przeglądu</label>
                                            <input name="NewVehicle.InspectionDate" type="date" value="@editVehicle.InspectionDate.ToString("yyyy-MM-dd")" class="form-control" />
                                            <span asp-validation-for="NewVehicle.InspectionDate" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Właściciel</label>
                                            <input name="NewVehicle.Owner" value="@editVehicle.Owner" class="form-control" />
                                            <span asp-validation-for="NewVehicle.Owner" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                                        <button type="submit" class="btn btn-primary">Zapisz</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="deleteModal-@vehicle.Id" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Potwierdzenie usunięcia</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-start">
                                    Czy na pewno chcesz usunąć pojazd <strong>@vehicle.RegistrationNumber</strong>? <br/>
                                    Tej operacji nie można cofnąć.
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                                    <form method="post" asp-page-handler="Delete">
                                        <input type="hidden" name="id" value="@vehicle.Id" />
                                        <input type="hidden" name="sortOrder" value="@Model.CurrentSort" />
                                        <input type="hidden" name="pageIndex" value="@Model.PageIndex" />
                                        <input type="hidden" name="currentFilter" value="@Model.CurrentFilter" />
                                        <button type="submit" class="btn btn-danger">Usuń</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </tbody>
        </table>
    </div>

    @{
        var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
        var nextDisabled = !Model.HasNextPage ? "disabled" : "";
    }

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item @prevDisabled">
                <a asp-page="./Index"
                   asp-route-sortOrder="@Model.CurrentSort"
                   asp-route-pageIndex="@(Model.PageIndex - 1)"
                   asp-route-currentFilter="@Model.CurrentFilter"
                   class="page-link">
                    Poprzednia
                </a>
            </li>
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                    <a asp-page="./Index"
                       asp-route-sortOrder="@Model.CurrentSort"
                       asp-route-pageIndex="@i"
                       asp-route-currentFilter="@Model.CurrentFilter"
                       class="page-link">
                        @i
                    </a>
                </li>
            }
            <li class="page-item @nextDisabled">
                <a asp-page="./Index"
                   asp-route-sortOrder="@Model.CurrentSort"
                   asp-route-pageIndex="@(Model.PageIndex + 1)"
                   asp-route-currentFilter="@Model.CurrentFilter"
                   class="page-link">
                    Następna
                </a>
            </li>
        </ul>
    </nav>
</div>

@functions {
    string GetSortIcon(string column)
    {
        const string upArrow = "<i class=\"bi bi-arrow-up\"></i>";
        const string downArrow = "<i class=\"bi bi-arrow-down\"></i>";
        const string neutralArrow = "<i class=\"bi bi-arrow-down-up text-muted\" style=\"opacity: 0.5;\"></i>";

        if (column.ToLower() == "name")
        {
            return string.IsNullOrEmpty(Model.CurrentSort) ? upArrow :
                   Model.CurrentSort == "name_desc" ? downArrow :
                   neutralArrow;
        }

        return Model.CurrentSort == column.ToLower() + "_asc" ? upArrow :
               Model.CurrentSort == column.ToLower() + "_desc" ? downArrow :
               neutralArrow;
    }
}

@{
    var isAddError = ViewData["OpenAddModal"] as bool? == true;
    var addVehicle = isAddError ? Model.NewVehicle : new EwidencjaWeb.Models.Vehicle { InspectionDate = DateTime.Today };
}

<div class="modal fade" id="addVehicleModal" tabindex="-1" aria-labelledby="addVehicleModalLabel" aria-hidden="true" @(isAddError ? "data-auto-open=true" : "")>
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Add">
                <div class="modal-header">
                    <h5 class="modal-title" id="addVehicleModalLabel">Dodaj pojazd</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="NewVehicle.Id" value="00000000-0000-0000-0000-000000000000" />
                    <input type="hidden" name="sortOrder" value="@Model.CurrentSort" />
                    <input type="hidden" name="pageIndex" value="@Model.PageIndex" />
                    <input type="hidden" name="currentFilter" value="@Model.CurrentFilter" />
                    
                    <div class="mb-3">
                        <label asp-for="NewVehicle.RegistrationNumber" class="form-label"></label>
                        <input asp-for="NewVehicle.RegistrationNumber" class="form-control" value="@addVehicle.RegistrationNumber" />
                        <span asp-validation-for="NewVehicle.RegistrationNumber" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="NewVehicle.Brand" class="form-label"></label>
                        <input asp-for="NewVehicle.Brand" class="form-control" value="@addVehicle.Brand" />
                        <span asp-validation-for="NewVehicle.Brand" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="NewVehicle.Model" class="form-label"></label>
                        <input asp-for="NewVehicle.Model" class="form-control" value="@addVehicle.Model" />
                        <span asp-validation-for="NewVehicle.Model" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="NewVehicle.YearOfProduction" class="form-label"></label>
                        <input asp-for="NewVehicle.YearOfProduction" class="form-control" value="@(isAddError ? addVehicle.YearOfProduction.ToString() : "")" />
                        <span asp-validation-for="NewVehicle.YearOfProduction" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="NewVehicle.InspectionDate" class="form-label"></label>
                        <input asp-for="NewVehicle.InspectionDate" class="form-control" type="date" value="@addVehicle.InspectionDate.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="NewVehicle.InspectionDate" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="NewVehicle.Owner" class="form-label"></label>
                        <input asp-for="NewVehicle.Owner" class="form-control" value="@addVehicle.Owner" />
                        <span asp-validation-for="NewVehicle.Owner" class="text-danger"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var modalToOpen = document.querySelector('[data-auto-open="true"]');

            if (modalToOpen) {
                var modal = new bootstrap.Modal(modalToOpen);
                modal.show();
            }

            var carouselElement = document.querySelector('#adCarousel');
            if (carouselElement) {
                var carousel = new bootstrap.Carousel(carouselElement, {
                    interval: 3000,
                    ride: 'carousel'
                });
            }

            setTimeout(function () {
                var alerts = document.querySelectorAll('.alert');

                alerts.forEach(function (alert) {
                    var bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });
    </script>
}
